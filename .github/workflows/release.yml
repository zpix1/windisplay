name: Release Tauri App

on:
  push:
    tags:
      - "v*" # Triggers on version tags like v1.0.0

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "windows-latest"
            args: "--target x86_64-pc-windows-msvc"

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install frontend dependencies
        run: npm ci

      - name: Extract release notes from CHANGELOG.md
        id: extract_release_notes
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart('v')
          $changelogPath = "CHANGELOG.md"
          if (-not (Test-Path $changelogPath)) {
            Write-Error "CHANGELOG.md not found"
            exit 1
          }
          $changelog = Get-Content -Path $changelogPath -Raw
          $escapedVersion = [Regex]::Escape($version)
          $pattern = "^\#\# \[$escapedVersion\][\s\S]*?(?=^\#\# \[|\Z)"
          $match = [Regex]::Match($changelog, $pattern, [Text.RegularExpressions.RegexOptions]::Multiline)
          if (-not $match.Success) {
            Write-Error "Release notes for version $version not found in CHANGELOG.md"
            exit 1
          }
          $notes = $match.Value.Trim()
          Add-Content -Path $env:GITHUB_OUTPUT -Value "release_body<<EOF"
          Add-Content -Path $env:GITHUB_OUTPUT -Value $notes
          Add-Content -Path $env:GITHUB_OUTPUT -Value "EOF"

      - name: Build and release Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Optional: Add code signing secrets if you have a certificate
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "WinDisplay v__VERSION__"
          releaseBody: |
            WinDisplay v__VERSION__

            **Installation:**
            1. Download the `.exe` installer below
            2. Run the installer
            3. The app will be available in your System Tray

            **Changes:**

            ${{ steps.extract_release_notes.outputs.release_body }}
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
